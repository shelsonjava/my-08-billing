<DataSource
	ID="FindTransportDS"
	serverType="sql"
	tableName="transports"
	qualifyColumnNames="false"
	dropExtraFields = "false">
	<fields>
		<field name="transport_id"				type="integer"		title="transport_id"			hidden="true"	primaryKey="true" />
		<field name="name_descr"				type="text"			title="name_descr"/>
		<field name="transport_place_geo_out"	type="text"			title="transport_place_geo_out"/>
		<field name="transport_place_geo_in"	type="text"			title="transport_place_geo_in"/>
		<field name="transport_price_geo"		type="text"			title="transport_price_geo"/>
		<field name="transport_company_geo"		type="text"			title="transport_company_geo"/>
		<field name="transport_plane_geo"		type="text"			title="transport_plane_geo"/>
		<field name="trip_criteria"				type="text"			title="trip_criteria"/>
		<field name="note_geo"					type="text"			title="note_geo"/>
		<field name="days_descr"				type="text"			title="days_descr"/>
		<field name="out_time"					type="datetime"		title="out_time"/>
		<field name="in_time"					type="datetime"		title="in_time"/>
		<field name="days"						type="integer"		title="days"/>
		<field name="note_crit"					type="integer"		title="note_crit"/>
		<field name="note_eng"					type="text"			title="note_eng"/>
		<field name="transport_no"				type="text"			title="transport_no"/>
		<field name="transport_price_eng"		type="text"			title="transport_price_eng"/>
		<field name="otown_name"			type="text"			title="otown_name"/>
		<field name="itown_name"			type="text"			title="itown_name"/>
		<field name="ostation"					type="text"			title="ostation"/>
		<field name="istation"					type="text"			title="istation"/>
		<field name="cmt"						type="text"			title="cmt"/>
		<field name="c_out_time"				type="text"			title="c_out_time"/>
		<field name="c_in_time"					type="text"			title="c_in_time"/>
		<field name="alarm"						type="text"			title="alarm"/>
	</fields>

	<operationBindings>		

    	<operationBinding operationId="findAllTransportsCC" operationType="fetch">
    		<selectClause>   			
    			  	   distinct 
				       t.transp_schedule_id as transport_id,
				       t.days,
				       getWeekDays(t.days) as days_descr,
				       t.arrival_time as in_time,
				       t.important as note_crit,
				       t.remark as note_eng,
				       t.remark as note_geo,
				       t.depart_time as out_time,
				       t.price_descr as transport_price_geo,
				       t.transp_model_descr as trip_criteria,
				       tt.name_descr,
				       oc.town_name||' '||o.name_descr as transport_place_geo_out,
				       ic.town_name||' '||i.name_descr as transport_place_geo_in,
				       tc.name_descr as transport_company_geo,
					   tp.name_descr as transport_plane_geo,
				       oc.town_name as otown_name,
				       ic.town_name as itown_name,
				       o.name_descr as ostation,
				       i.name_descr as istation,
				       to_char((t.arrival_time+ic.normal_gmt/24),'HH24:mi') cmt1,
				       to_char((t.arrival_time+decode(icc.season,0,ic.normal_gmt/24,ic.winter_gmt/24)),'HH24:mi') cmt,
				       to_char(t.depart_time,'HH24:MI') c_out_time,
				       to_char(t.arrival_time ,'HH24:MI') c_in_time,
				       '!!!!!' as alarm
			</selectClause> 
			<tableClause>
				<![CDATA[
					     transp_schedules t 
						 inner join transp_types tt on t.transp_type_id = tt.transp_type_id
						 left join  transp_companies tc on t.transp_comp_id = tc.transp_comp_id
 						 left join  transp_resource tp on t.transp_res_id = tp.transp_res_id
						 left join  transp_items d on t.transp_schedule_id = d.transp_schedule_id 
						 
						 #if( ($criteria.o_town_id && $criteria.i_town_id) || ($criteria.o_country_id && $criteria.i_country_id) )
						  	left join  transp_items d1 on t.transp_schedule_id = d1.transp_schedule_id and d1.item_order >= d.item_order 
						 #end
						  
						 inner join  transp_stations o on o.transp_stat_id = t.depart_transp_stat_id
						 inner join  transp_stations i on i.transp_stat_id = t.arrival_transp_stat_id
						 left join  towns oc on oc.town_id = o.town_id
						 left join  towns ic on ic.town_id = i.town_id
						 left join  countries icc on icc.country_id = ic.country_id
						 left join  transp_stations dp on dp.transp_stat_id = d.transp_station_id
						 left join  towns dpc on dpc.town_id = dp.town_id
						 
						 #if( ($criteria.o_town_id && $criteria.i_town_id) || ($criteria.o_country_id && $criteria.i_country_id) )
							 left join  transp_stations dp1 on dp1.transp_stat_id = d1.transp_station_id
							 left join  towns dpc1 on dpc1.town_id = dp1.town_id
						  #end
				]]>  
			</tableClause>
			<whereClause><![CDATA[
					   1 = 1
				       #if($criteria.transp_type_id) and tt.transp_type_id = $criteria.transp_type_id #end
				       #if($criteria.c_days)  and (bitand(t.days, $criteria.c_days) = $criteria.c_days OR t.days = 0) #end
				       #if($criteria.transp_model_descr_param) and t.transp_model_descr like '%'||($criteria.transp_model_descr_param)||'%' #end
					   #if($criteria.transp_model_descr) and t.transp_model_descr like '%'||($criteria.transp_model_descr)||'%' #end
					   #if($criteria.remark) and t.remark like '%'||($criteria.remark)||'%' #end
					   #if($criteria.otown_name) and oc.town_name like '%'||($criteria.otown_name)||'%' #end
					   #if($criteria.itown_name) and ic.town_name like '%'||($criteria.itown_name)||'%' #end
					   #if($criteria.ostation) and o.name_descr like '%'||($criteria.ostation)||'%' #end
					   #if($criteria.istation) and i.name_descr  like '%'||($criteria.istation)||'%' #end
					   #if($criteria.transport_company_geo) and tc.name_descr like '%'||($criteria.transport_company_geo)||'%' #end
					   #if($criteria.transport_plane_geo) and tp.name_descr like '%'||($criteria.transport_plane_geo)||'%' #end
					   #if($criteria.days_descr) and getWeekDays(t.days) like '%'||($criteria.days_descr)||'%' #end
				       #if($criteria.trip_criteria_param) and t.transp_model_descr like '%'||($criteria.trip_criteria_param)||'%' #end
				       
				       
				       #if($criteria.o_town_id && $criteria.i_town_id) 
				       	    AND (
           						    (oc.town_id = $criteria.o_town_id or dpc.town_id = $criteria.o_town_id) 
       							and (ic.town_id = $criteria.i_town_id or dpc1.town_id = $criteria.i_town_id)                                
   							)	
				       #elseif($criteria.o_town_id)
				       		and (oc.town_id = $criteria.o_town_id or dpc.town_id = $criteria.o_town_id)
				       		
				       #elseif($criteria.i_town_id)
				        	and (ic.town_id = $criteria.i_town_id or dpc.town_id = $criteria.i_town_id)				        	
				       #end
				       
				       
				       
				       #if($criteria.o_country_id && $criteria.i_country_id) 
				       	    AND (
           						    (oc.country_id = $criteria.o_country_id or dpc.country_id = $criteria.o_country_id) 
       							and (ic.country_id = $criteria.i_country_id or dpc1.country_id = $criteria.i_country_id)                                
   							)	
				       #elseif($criteria.o_country_id)
				       		and (oc.country_id = $criteria.o_country_id or dpc.country_id = $criteria.o_country_id)
				       		
				       #elseif($criteria.i_country_id)
				        	and (ic.country_id = $criteria.i_country_id or dpc.country_id = $criteria.i_country_id)				        	
				       #end
				       
				]]>  
			</whereClause> 
			<orderClause>oc.town_name, ic.town_name, t.depart_time</orderClause>
    	</operationBinding>
    	
    	
    	
    </operationBindings>	
</DataSource>