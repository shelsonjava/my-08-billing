<DataSource
	ID="ContractorsDS"
	serverType="sql"
	tableName="contracts"
	qualifyColumnNames="false"
	dropExtraFields = "false">
	<fields>
		<field name="contract_id"			type="integer"		title="ID"					hidden="true" primaryKey="true" />
		<field name="block"					type="integer"		title="block"				hidden="true"/>
		<field name="organization_id"		type="integer"		title="organization_id"				hidden="true"/>
		<field name="organization_name"		type="text"			title="organization_name"/>
		<field name="start_date"			type="date"			title="start_date"/>
		<field name="end_date"				type="date"			title="end_date"/>
		<field name="critical_number"		type="integer"		title="critical_number"		hidden="true"/>
		<field name="price"					type="any"			title="price"/>
		<field name="note"					type="text"			title="note"/>
		<field name="is_budget"				type="integer"		title="is_budget"			hidden="true"/>
		<field name="price_type"			type="integer"		title="price_type"			hidden="true"/>
		<field name="sms_warning"			type="integer"		title="sms_warning"			hidden="true"/>
		<field name="loggedUserName"		type="text"			title="loggedUserName"		hidden="true"/>
		<field name="contractorAdvPrices"	type="any"			title="contractorAdvPrices" hidden="true"/>
		<field name="contractorAdvPhones"	type="any"			title="contractorAdvPhones" hidden="true"/>
		<field name="block_type"			type="integer"		title="block_type"			hidden="true"/>
		<field name="contractor_call_cnt"	type="integer"		title="contractor_call_cnt"	hidden="true"/>
		<field name="phone"					type="text"			title="phone"				hidden="true"/>
		<field name="price_type_descr"		type="text"			title="price_type_descr"	hidden="true"/>
		<field name="range_curr_price"		type="any"			title="range_curr_price"	hidden="true"/>
		<field name="checkContractor"		type="integer"		title="checkContractor"		hidden="true"/>		
		<field name="call_count"			type="integer"		title="call_count"			hidden="true"/>
		<field name="amount"				type="any"			title="amount"				hidden="true"/>
		<field name="billing_company_name"	type="text"			title="billing_company_name"	hidden="true"/>
		<field name="service_description"		type="text"			title="service_name_geo"	hidden="true"/>
		<field name="call_date"				type="datetime"		title="call_date"			hidden="true"/>
		<field name="charge_date"			type="datetime"		title="charge_date"			hidden="true"/>
		<field name="limitType"				type="integer"		title="limitType"			hidden="true"/>
		<field name="contractor_type"		type="integer"		title="contractor_type"		hidden="true"/>
	</fields>
	<operationBindings>		

		<serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.ContractorsDMI"/>

		<!-- Add Contractor -->
		<operationBinding operationType="add" operationId="addContractor" serverMethod="addEditContractor">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.ContractorsDMI"/>
        </operationBinding>
        
		<!-- Contractor Update -->
		<operationBinding operationType="update" operationId="updateContractor" serverMethod="addEditContractor">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.ContractorsDMI"/>
        </operationBinding>
        
        <!-- Delete Contractor -->
		<operationBinding operationType="remove" operationId="removeContractor" serverMethod="removeContractor">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.ContractorsDMI"/>
        </operationBinding>
        
        <!-- Check Contractor -->
		<operationBinding operationType="update" operationId="checkContractorNumbers" serverMethod="checkContractorNumbers">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.ContractorsDMI"/>
        </operationBinding>
        
        <!-- Getting Contractor Call Count -->
		<operationBinding operationType="update" operationId="getContractorCallCnt" serverMethod="getContractorCallCnt">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.ContractorsDMI"/>
        </operationBinding>
        
        <!-- Getting Contractor Call Charges -->
		<operationBinding operationType="update" operationId="getContractorCharges" serverMethod="getContractorCharges">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.ContractorsDMI"/>
        </operationBinding>
        
        <!-- Block Contractor -->
		<operationBinding operationType="update" operationId="blockUnBlockContractor" serverMethod="blockUnBlockContractor">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.ContractorsDMI"/>
        </operationBinding>
        
        <!-- Contractor Range Price Update Manually -->
        <operationBinding operationType="update" operationId="updateContractorRangePrice" serverMethod="updateContractorRangePrice">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.ContractorsDMI"/>
        </operationBinding>
        
        
         <!-- Contractor Range Price Update Manually -->
        <operationBinding operationType="fetch" operationId="checkPhones" serverMethod="checkPhones">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.ContractorsDMI"/>
        </operationBinding>           
        
    	<operationBinding operationId="searchAllContractors" operationType="fetch">
    		<selectClause>   			
	    			t.contract_id, 
					t.organization_id, 
					t.start_date, 
					t.end_date, 
					t.critical_number, 
					t.price, 
					t.note, 
					t.is_budget, 
					t.price_type, 
					t.block, 
					t.sms_warning, 
					t.range_curr_price,
				  	mo1.organization_name,
				  	decode(t.price_type,0,'მარტ.','რთული') as price_type_descr
			</selectClause> 
			<tableClause>contracts t, organizations mo1</tableClause>
			<whereClause><![CDATA[
				 t.organization_id = mo1.organization_id
				 #if($criteria.org_name) 
							#foreach($str in $criteria.org_name.split(" "))
								and mo1.organization_name like '%'||'$str'||'%'
							#end
				 #end
				 #if($criteria.is_budget) and t.is_budget = $criteria.is_budget #end
				 #if($criteria.price_type) and t.price_type = $criteria.price_type #end
				 #if($criteria.phone)
				 	and t.contract_id in (select tt.contract_id from contractor_phones tt where tt.phone = $criteria.phone) 				 	
				 #end
				 #if($criteria.limitType && $criteria.limitType == 0 ) and t.critical_number <> -999999999 #end
				 #if($criteria.limitType && $criteria.limitType == 1 ) and t.critical_number =  -999999999 #end
				 #if($criteria.contract_id) and t.contract_id =  $criteria.contract_id #end
				]]>  
			</whereClause> 
			<orderClause>t.contract_id</orderClause>
    	</operationBinding>
    	
    	
    	
    	
    	
    	<operationBinding operationId="getCallsCountByMainAndYM" operationType="fetch">
    		<selectClause>   		
    			  get_contractor_calls_count(to_number(to_char(sysdate,'YYMM')),t.contract_id)	as contractor_call_cnt 			  
			</selectClause> 
			<tableClause>contracts t</tableClause>
			<whereClause><![CDATA[
				 t.organization_id=$criteria.organization_id
				]]>  
			</whereClause> 			
    	</operationBinding>
    	
    	
    	<operationBinding operationId="getContractorsBilling1" operationType="add">
            <customSQL>
            	 <![CDATA[
            	 	{call makecontractorsbill($values.ym)}            	 	
            	 ]]>
            </customSQL> 
        </operationBinding>

		<operationBinding operationId="getFullContrBillMain1" operationType="fetch">
    		<selectClause>
    			  mo.organization_name,
			      t.call_count,
			      t.price,
			      t.amount
			</selectClause> 
			<tableClause>contractor_bill t, contracts c, organizations mo </tableClause>
			<whereClause><![CDATA[
				 t.contractor_id = c.contract_id and c.organization_id = mo.organization_id
				 and t.ym = $criteria.ym
				 #if($criteria.contract_id) and c.contract_id = $criteria.contract_id #end	
				 #if($criteria.is_budget) and c.is_budget = $criteria.is_budget #end			 
				]]>  
			</whereClause> 
			<orderClause>mo.organization_name</orderClause>
    	</operationBinding>
    	
    	<operationBinding operationId="getFullContrBillMain2" operationType="fetch">
    		<selectClause>
    			          tc.billing_company_name,
					      mo.organization_name,
					      s.service_description, 
					      bi.phone,
					      bi.call_date,
					      bi.charge_date,
					      bi.price
			</selectClause> 
			<tableClause> contractor_bill_items bi, contracts c, organizations mo, BILLING_COMPANIES tc, service_prices s </tableClause>
			<whereClause><![CDATA[
				 bi.contractor_id = c.contract_id and c.organization_id = mo.organization_id and 
				 bi.billing_company_id = tc.billing_company_id and  bi.service_id = s.service_price_id  and bi.ym = $criteria.ym
				 #if($criteria.contract_id) and c.contract_id = $criteria.contract_id #end				 
				 #if($criteria.is_budget) and c.is_budget = $criteria.is_budget #end
				]]>  
			</whereClause> 
			<orderClause>tc.billing_company_name, mo.organization_name, bi.phone, s.service_description, bi.call_date, bi.charge_date </orderClause>
    	</operationBinding>
    	
    </operationBindings>	
</DataSource>