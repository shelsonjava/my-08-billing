<DataSource 
	ID="SubscriberDS" 
	serverType="sql"
	tableName="subscribers" 
	qualifyColumnNames="false"
	dropExtraFields = "false">
	<fields>
		<field name="subscriber_id" 				type="integer"	title="ABonent ID"			hidden="true"	primaryKey="true" />
		<field name="addr_id" 						type="integer"	title="Address ID"			hidden="true"/>
		<field name="name" 							type="text" 	title="First Name"/>
		<field name="family_name"  					type="text"		title="Last Name" />
		<field name="phones" 						type="text"		title="Phones" />
		<field name="phone" 						type="text"		title="Phone" />
		<field name="shown_phones" 					type="text"		title="Phones" />
		<field name="city"							type="text" 	title="City" />
		<field name="street_name"					type="text" 	title="Street" />
		<field name="street_location"				type="text" 	title="Street Location Geo" hidden="true"/>
		<field name="name_id" 						type="integer"	title="First Name ID"		hidden="true"/>		
		<field name="family_name_id" 				type="integer"	title="Last Name ID" 		hidden="true"/>
		<field name="town_id" 						type="integer"	title="City ID"				hidden="true"/>
		<field name="street_id" 					type="integer"	title="Street ID"			hidden="true"/>
		<field name="town_district_id" 				type="integer"	title="City Region ID"		hidden="true"/>
		<field name="hidden_by_request" 			type="integer"	title="Address Hide"		hidden="true"/>
		<field name="full_address"					type="text"		title="Address Suffix Geo"	hidden="true"/>
		<field name="anumber"						type="text"		title="Address Number"		hidden="true"/>
		<field name="block"							type="text"		title="Address Block"		hidden="true"/>
		<field name="appt"							type="text"		title="Address Appt"		hidden="true"/>
		<field name="descr"							type="text"		title="Address Descr"		hidden="true"/>
		<field name="street_to_town_district_id" 	type="integer"	title="Street District ID"	hidden="true"/>		
		<field name="address" 						type="text"		title="address"				hidden="true"/>
		<field name="loggedUserName" 				type="text"		title="address"				hidden="true"/>
		<field name="town_name" 					type="text"		title="address"				hidden="true"/>
		<field name="concat_address" 				type="text"		title="address"/>
		<field name="phone_state"					type="text"		title="Phone State"/>
		<field name="phone_state_id"				type="text"		title="Phone State"/>
		<field name="phone_contract_type_desr"		type="text"		title="Phone Status"/>
		<field name="phone_contract_type"			type="integer"	title="Phone Status"/>
		<field name="phone_type"					type="text"		title="Phone Type"/>
		<field name="is_parallel"					type="integer"	title="Is Parallel Descr"/>
		<field name="is_parallel_descr"				type="text"		title="Is Parallel Descr"/>
		<field name="ph_hidden_by_request_descr"	type="text"		title="Is Parallel Descr"/>
		<field name="ph_hidden_by_request"			type="integer"	title="Is Parallel Descr"/>
		<field name="hist_start_date"   			type="datetime" title="hs_hist_start_date"/>
		<field name="hist_end_date"   				type="datetime" title="hs_hist_end_date"/>
		<field name="upt_date"   					type="datetime" title="upt_date"/>
		<field name="on_user"  						type="text"  	title="hs_on_user"/>
		<field name="off_user"		   				type="text"  	title="hs_off_user"/>
		<field name="off_user"		   				type="text"  	title="hs_off_user"/>
		<field name="rdeleted"   					type="boolean"  title="hph_rcn" 			sqlStorageStrategy="integer"/>
	</fields>
	
	
	<operationBindings>
	 
		<!-- Add Subscriber -->
		<operationBinding operationType="add" operationId="addSubscriber" serverMethod="saveOrUpdateSubscriber">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.SubscriberDMI"/>
        </operationBinding>
		<operationBinding operationType="update" operationId="updateSubscriber" serverMethod="saveOrUpdateSubscriber">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.SubscriberDMI"/>
        </operationBinding>
        
        
        <!-- remove Subscriber -->
		<operationBinding operationType="remove" operationId="removeSubscriber" serverMethod="removeSubscriber">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.SubscriberDMI"/>
        </operationBinding>
        
      
        
		<!-- FETCH -->
		<operationBinding operationId="customSearch"
			operationType="fetch">			
			<selectClause>
					/*+ index(lmn,#if($criteria.family_name) UK_LASTNAMES) #else PK_LASTNAMES_ID #end
						index(lmn,#if($criteria.name) UK_FIRSTNAME) #else PK_FIRSTNAME_ID #end 
					*/
				   t.family_name,
			       t.name,
			       pnm.phone phones,
			       pnm.phone,
			       t.subscriber_id,
			       #if($criteria.for_call_center) 
			       	decode(spm.hidden_by_request,1,map_char_codes_geo('dafaruli'), 
			       		decode(pnm.phone_state_id,52102,map_char_codes_geo('moxs.'),'032' || pnm.phone)
			       		) shown_phones,
			       #else
				       t.addr_id,
				       t.street_name,
				       t.street_location,
				       t.name_id,
				       t.family_name_id,
				       t.town_id,
				       t.street_id,
				       t.town_district_id,
				       t.hidden_by_request,
				       t.full_address,
				       t.anumber,
				       t.block,
				       t.appt,
				       t.descr,
				       t.street_to_town_district_id,
				       pnm.is_parallel,
				       pnm.phone_type_id,
				       spm.phone_contract_type,
				       spm.hidden_by_request ph_hidden_by_request,
				       t.upt_date,
				       decode(pnm.is_parallel,
			              0,
			              'ჩვეულებრივი',
			              1,
			              'პარალელური') as is_parallel_descr,
			           decode(spm.hidden_by_request, 0, 'ღია', 1, 'დაფარულია') ph_hidden_by_request_descr,
			           getDescription(spm.phone_contract_type) phone_contract_type_desr,
			           getDescription(pnm.phone_type_id) phone_type,
				    #end
 					#if($criteria.for_call_center) 
 					   		decode(spm.hidden_by_request,1,map_char_codes_geo('dafaruli'),
 					#end
 					   getDescription(pnm.phone_state_id)
 					#if($criteria.for_call_center)
 					   ) 
 					#end   
 					phone_state,
 					#if($criteria.for_call_center)
 						decode(t.hidden_by_request,1,map_char_codes_geo('dafaruli'),t.town_name) town_name,
 					    decode(t.hidden_by_request,1,map_char_codes_geo('dafaruli'),t.concat_address) concat_address
 					#else
 						town_name,
 						concat_address
 					#end
			</selectClause>
			<tableClause>
			  	   v_full_subscriber              t,
			  	   SUBSCRIBER_TO_PHONES			  spm,
			  	   phone_numbers 				  pnm
       		</tableClause>
			<whereClause><![CDATA[ 
				   	t.subscriber_id=spm.subscriber_id
				   	and pnm.phone_number_id=spm.phone_number_id
					#if($criteria.subscriber_id) AND t.subscriber_id = $criteria.subscriber_id #end
					#if($criteria.name_id) AND t.name_id = $criteria.name_id #end
					#if($criteria.family_name_id) AND t.family_name_id = $criteria.family_name_id #end
					#if($criteria.town_id) AND t.town_id = $criteria.town_id #end
					#if($criteria.town_district_id) AND t.town_district_id = $criteria.town_district_id #end
					
					#if(!$criteria.for_call_center)
							#if($criteria.street_id) AND t.street_id = $criteria.street_id #end
							#if($criteria.street_name_geo) AND street_location like '%'||$criteria.street_name_geo||'%' #end
							#if($criteria.anumber) AND anumber like '%%'||($criteria.anumber)||'%' #end
							#if($criteria.block) AND block like '%%'||($criteria.block)||'%' #end
							#if($criteria.appt) AND appt like '%%'||($criteria.appt)||'%' #end
							#if($criteria.descr) AND descr like '%%'||($criteria.descr)||'%' #end
							#if($criteria.name) AND name like '%%'||($criteria.name)||'%' #end
							#if($criteria.family_name) AND family_name like '%%'||($criteria.family_name)||'%' #end
							#if($criteria.full_address) AND full_address like '%%'||($criteria.full_address)||'%' #end
					#end
					#if($criteria.hidden_by_request) AND hidden_by_request = $criteria.hidden_by_request #end
					#if($criteria.name_param) AND name like '%%'||($criteria.name_param)||'%' #end
					#if($criteria.family_name_param) AND family_name like '%%'||($criteria.family_name_param)||'%' #end
					#if($criteria.phone||$criteria.is_parallel
							||$criteria.phone_contract_type||$criteria.phone_contract_type
							||$criteria.phone_state_id||$criteria.phone_type_id||$criteria.ph_hidden_by_request
						)
								 #if($criteria.for_call_center)  AND spm.hidden_by_request =0 #end
						         #if($criteria.phone) and pnm.phone = $criteria.phone #end
						         #if($criteria.is_parallel) AND pnm.is_parallel = $criteria.is_parallel #end
								 #if($criteria.phone_contract_type) AND spm.phone_contract_type = $criteria.phone_contract_type #end
								 #if($criteria.phone_state_id) AND pnm.phone_state_id = $criteria.phone_state_id #end
								 #if($criteria.phone_type_id) AND pnm.phone_type_id = $criteria.phone_type_id #end
								 #if($criteria.ph_hidden_by_request) AND spm.hidden_by_request = $criteria.ph_hidden_by_request #end
							
			        #end
					#if($criteria.street_name_param) 
						and  t.addr_id in (
							select /*+ index(t1,IDX_ADDR_CONCAT_ADDRESS)*/ t1.addr_id
          						from addresses t1 where 1=1 #foreach($str in $criteria.street_name_param.split(" "))
								and instr(t1.concat_address, '$str')>0
							#end
						)
							
					#end
				]]>
			</whereClause>	
		</operationBinding>
		
		<operationBinding operationId="histSearch"
			operationType="fetch">			
			<selectClause>
				family_name, 
				name, 
				subscriber_id, 
				addr_id, 
				street_name, 
				street_location, 
				name_id, 
				family_name_id, 
				town_id, 
				street_id, 
				town_district_id, 
				hidden_by_request, 
				full_address, 
				anumber, 
				block, 
				appt, 
				descr, 
				street_to_town_district_id, 
				town_name, 
				address, 
				town_district_name, 
				concat_address, 
				calc_short_address, 
				hist_start_date, 
				hist_end_date, 
				start_rcn, 
				end_rcn, 
				on_user, 
				off_user,
				rdeleted
					
			</selectClause>
			<tableClause>
			  	   hist_subscriber_view t
       		</tableClause>
			<whereClause><![CDATA[ 
				   	1 = 1
				   	#if($criteria.subscriber_id) AND t.subscriber_id = $criteria.subscriber_id #end
				   	#if($criteria.lastname) AND t.family_name like ($criteria.lastname)||'%' #end
				   	#if($criteria.firstname) AND t.name like ($criteria.firstname)||'%' #end
				   	#if($criteria.concat_address) AND t.concat_address like '%'||($criteria.concat_address)||'%' #end
				   	#if($criteria.phone_number)
				   	and exists (select 1
				          from hist_subscriber_to_phones htp
				              ,hist_phone_numbers        hph
				         where htp.subscriber_id = t.subscriber_id
				           and htp.phone_number_id = hph.phone_number_id
				           and hph.phone = ($criteria.phone_number) )				   	
				   	 #end
				   	]]>
			</whereClause>	
			<orderClause>t.subscriber_id, start_rcn desc</orderClause>
		</operationBinding>
		
	</operationBindings>
</DataSource>