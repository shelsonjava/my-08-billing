<DataSource 
	ID="OrgDS"
    serverType="sql"
    tableName="organizations"      
    qualifyColumnNames="false"
    dropExtraFields = "false">
    
	<fields>
		<field name="organization_id"				type="integer"		title="organization_id"					hidden="true" 	primaryKey="true" />
		<field name="parrent_organization_id"		type="integer"  	title="parrent_organization_id"			hidden="true"	foreignKey="OrgDS.organization_id"  detail="true"/>
		<field name="parrent_organization_id1"		type="integer"  	title="parrent_organization_id1"		hidden="true"/>
		<field name="organization_name"				type="text"  		title="organization_name"/>
		<field name="remark"						type="text"  		title="remark"/>
		<field name="ident_code"					type="text"  		title="ident_code"/>
		<field name="ident_code_new"				type="text"  		title="ident_code_new"/>
		<field name="work_hours"					type="text"  		title="work_hours"/>
		<field name="found_date"					type="datetime"  	title="found_date"/>
		<field name="email_address"					type="text"  		title="email_address"/>
		<field name="web_address"					type="text"  		title="web_address"/>
		<field name="social_address"				type="text"  		title="social_address"/>
		<field name="additional_info"				type="text"  		title="additional_info"/>
		<field name="contact_person"				type="text"  		title="contact_person"/>
		<field name="day_offs"						type="integer"  	title="day_offs"/>
		<field name="day_offs_descr"				type="text"  		title="day_offs_descr"/>
		<field name="staff_count"					type="integer"  	title="staff_count"/>
		<field name="organization_index"			type="text"  		title="organization_index"/>
		<field name="organization_name_eng"			type="text"  		title="organization_name_eng"/>
		<field name="real_address_descr"			type="text"  		title="real_address_descr"/>
		<field name="legal_address_descr"			type="text"  		title="legal_address_descr"/>
		<field name="full_address_not_hidden"		type="text"  		title="full_address_not_hidden"/>
		<field name="call_center_address"			type="text"  		title="call_center_address"/>
		<field name="legal_form_desc_id"			type="integer"  	title="legal_form_desc_id"				hidden="true"/>
		<field name="status"						type="integer"  	title="status"							hidden="true"/>		
		<field name="important_remark"				type="integer"  	title="important_remark"				hidden="true"/>		
		<field name="town_name"						type="text"  		title="town_name"/>
		<field name="town_district_name"			type="text"  		title="town_district_name"/>	
		<field name="street_location"				type="text"  		title="street_location"/>
		<field name="street_index_text"				type="text"  		title="street_index_text"/>		
		<field name="index_text"					type="text"  		title="index_text"/>
		<field name="legal_form_desc"				type="text"  		title="legal_form_desc"/>		
		<field name="town_id"						type="integer"  	title="town_id"							hidden="true"/>		
		<field name="priority"						type="integer"  	title="priority"						hidden="true"/>
		<field name="priority_descr"				type="text"  		title="priority_descr"					/>
		<field name="super_priority"				type="integer"  	title="super_priority"					hidden="true"/>
		<field name="super_priority_descr"  		type="text"  		title="super_priority_descr"			/>
		<field name="street_name"					type="text"  		title="street_name"/>
		<field name="phone_number"					type="text"  		title="phone_number"/>		
		<field name="org_or_abon_type"				type="integer"  	title="org_or_abon_type"				hidden="true"/>
		<field name="hide"							type="integer"  	title="hide"							hidden="true"/>
		<field name="org_or_abon"					type="text"  		title="org_or_abon"/>
		<field name="phoneStatusID"					type="integer"  	title="phoneStatusID"					hidden="true"/>
		<field name="street_old_name"				type="text"  		title="street_old_name"/>
		<field name="address_hide"					type="integer"  	title="address_hide"					hidden="true"/>		
		<field name="contact_phones"				type="integer"  	title="contact_phones"					hidden="true"/>
		<field name="phone_status"					type="text"  		title="phone_status"/>
		<field name="organization_name_tree"		type="text"  		title="organization_name_tree"/>
		<field name="is_abonent"					type="integer"  	title="is_abonent"						hidden="true"/>
		<field name="town_district_id"				type="integer"  	title="town_district_id"				hidden="true"/>
		<field name="street_id"						type="integer"  	title="street_id"						hidden="true"/>
		<field name="legal_address_id"				type="integer"  	title="legal_address_id"				hidden="true"/>
		<field name="physical_address_id"			type="integer"  	title="physical_address_id"				hidden="true"/>
		<field name="hidden_by_request"				type="integer"  	title="hidden_by_request"				hidden="true"/>
		<field name="tree_org_parrent"				type="text"  		title="tree_org_parrent"/>
		<field name="tree_org_child"				type="text"  		title="tree_org_child"/>
		<field name="full_address"					type="text"  		title="full_address"/>
		<field name="block"							type="text"  		title="block"/>
		<field name="appt"							type="text"  		title="appt"/>
		<field name="descr"							type="text"  		title="descr"/>
		<field name="anumber"						type="text"  		title="anumber"/>
		<field name="street_indexes"				type="text"  		title="street_indexes"/>
		<field name="org_allert_by_buss_det"		type="text"  		title="org_allert_by_buss_det"/>
		<field name="chief"							type="text"  		title="chief"/>
		<field name="legal_addr_town_id"			type="integer"  	title="legal_addr_town_id"				hidden="true"/>
		<field name="legal_addr_street_id"			type="integer"  	title="legal_addr_street_id"			hidden="true"/>
		<field name="legal_addr_town_district_id"	type="integer"  	title="legal_addr_town_district_id"		hidden="true"/>
		<field name="legal_addr_hidden_by_request"	type="integer"  	title="legal_addr_hidden_by_request"	hidden="true"/>
		<field name="legal_addr_full_address"		type="text"  		title="legal_addr_full_address"			hidden="true"/>
		<field name="legal_addr_block"				type="text"  		title="legal_addr_block"				hidden="true"/>
		<field name="legal_addr_appt"				type="text"  		title="legal_addr_appt"					hidden="true"/>
		<field name="legal_addr_anumber"			type="text"  		title="legal_addr_anumber"				hidden="true"/>
		<field name="legal_addr_street_location"	type="text"  		title="legal_addr_street_location"		hidden="true"/>
		<field name="legal_addr_street_index_text"	type="text"  		title="legal_addr_street_index_text"	hidden="true"/>
		<field name="legal_full_address_not_hidden"	type="text"  		title="legal_full_address_not_hidden"	hidden="true"/>
		<field name="orgActivities"					type="any"  		title="orgActivities"					hidden="true"/>
		<field name="orgPartnerBanks"				type="any"  		title="orgPartnerBanks"					hidden="true"/>
		<field name="physicalAddrValues"			type="any"  		title="physicalAddrValues"				hidden="true"/>
		<field name="legalAddrValues"				type="any"  		title="legalAddrValues"					hidden="true"/>
		<field name="partBankUpdated"				type="integer"  	title="partBankUpdated"					hidden="true"/>
		<field name="ph_town_id"					type="integer"  	title="ph_town_id"						hidden="true"/>
		<field name="unique_ident_code"				type="integer"  	title="unique_ident_code"				hidden="true"/>
		<field name="original_org_name"				type="text"  		title="original_org_name"/>
		<field name="mainIdList"					type="any"  		title="mainIdList"						hidden="true"/>
		<field name="recCount" 						type="integer" 		title="recCount" 						hidden="true" />
		<field name="concat_phones"					type="text"  		title="concat_phones"					hidden="true"/>
		<field name="concat_activity_descrs"		type="text"  		title="concat_activity_descrs"			hidden="true"/>
		<field name="concat_org_partner_banks"		type="text"  		title="concat_org_partner_banks"/>
		<field name="hist_start_date"   			type="datetime" 	title="hs_hist_start_date"/>
		<field name="hist_end_date"   				type="datetime" 	title="hs_hist_end_date"/>
		<field name="on_user"  						type="text"  		title="hs_on_user"/>
		<field name="off_user"		   				type="text"  		title="hs_off_user"/>
		<field name="off_user"		   				type="text"  		title="hs_off_user"/>
		<field name="rdeleted"   					type="boolean"  	title="hph_rcn" 						sqlStorageStrategy="integer"/>
		<field name="parrent_organization"			type="text"  		title="parrent_organization"/>
		<field name="cust_order"					type="integer"  	title="cust_order"/>
		<field name="org_acctivity_name"			type="text"  		title="cust_order"/>
		<field name="org_activity_id"				type="integer"  	title="cust_order"/>
		
	</fields>
	<operationBindings>
	
	
		<!-- Add New Organization -->
		<operationBinding operationType="add" operationId="addOrganization" serverMethod="addOrUpdateOrganization">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.OrganizationDMI"/>
        </operationBinding>
        <operationBinding operationType="update" operationId="updateOrganization" serverMethod="addOrUpdateOrganization">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.OrganizationDMI"/>
        </operationBinding>
	
		 <!-- Sort Order -->
		<operationBinding operationType="update" operationId="updateOrgSortOrder" serverMethod="updateOrgSortOrder">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.OrganizationDMI"/>
        </operationBinding>
        
		<!-- Remove Organization -->
		<operationBinding operationType="remove" operationId="removeOrganization" serverMethod="removeOrganization">
			<serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.OrganizationDMI"/>            
        </operationBinding>
		
		 <!-- FETCH -->
        <operationBinding operationId="searchOrgReversed" operationType="fetch">
            <customSQL>
            	 <![CDATA[
            	 select *
				 from (select level m_level, t.*
				          from organizations t
				         start with t.organization_id = $criteria.organization_id
				        connect by prior t.organization_id = t.parrent_organization_id
				         order siblings by nvl(t.parrent_organization_id,0),t.priority) k
				 order by k.m_level desc
            	 ]]>
            </customSQL> 
        </operationBinding>
		
		
		<!-- FETCH -->
        <operationBinding operationId="orgCheckParrChild" operationType="fetch">
            <customSQL>
            	 <![CDATA[
            	  select 
            	  		count(1) as recCount
				  from (select level as my_level, t.*
				          from organizations t
				         start with t.organization_id = $criteria.curr_organization_id
				        connect by prior t.organization_id = t.parrent_organization_id) tt
				  where tt.my_level > 1
				   and tt.organization_id = $criteria.parr_organization_id
            	 ]]>
            </customSQL> 
        </operationBinding>
		
		<!-- FETCH -->
		<operationBinding operationId="customOrgSearchForCallCenterNew" operationType="fetch">			
			<selectClause><![CDATA[
						
						#if($criteria.only_count)
							count(1) as recCount
						#else						
							o.organization_id,
							o.parrent_organization_id,
							o.parrent_organization_id as parrent_organization_id1,
							#if($criteria.pp_organization_id)
								hr.my_rownum,
								lpad(' ', (hr.mylevel - 1) * 4, '.') || o.organization_name 
							#else
								o.organization_name 
							#end
							as organization_name,
							#if($criteria.need_phones)
								 (select 
								 		wm_concat(pn.phone) as concat_phones
								 from organization_depart_to_phones tt
								 inner join phone_numbers pn on pn.phone_number_id = tt.phone_number_id
								 where tt.org_department_id in
								       (select t.org_department_id
								          from organization_department t
								         where t.organization_id = o.organization_id)
								  and tt.for_contact = 1 ) as concat_phones,
								  
								  (select 
								  		wm_concat(tt.activity_description) as concat_activity_descrs 
								  from organization_to_activities t 
	       								inner join organization_activities tt on tt.org_activity_id = t.org_activity_id
								  where t.organization_id = o.organization_id ) as concat_activity_descrs,
							#end
							#if($criteria.isCallCenter)
								(select 
									 wm_concat(oo.organization_name) as concat_org_partner_banks 
								from organization_partner_banks t
	       						inner join organizations oo on oo.organization_id = t.part_bank_org_id
								where t.organization_id = o.organization_id) as concat_org_partner_banks,
							#end
							o.organization_name as original_org_name,
							a.concat_address_with_town as full_address_not_hidden,
							a1.concat_address_with_town as legal_full_address_not_hidden,
							decode(o.parrent_organization_id,null,null,'home') as tree_org_parrent,
			                decode((select min(1) from organizations ms1 where ms1.parrent_organization_id = o.organization_id),null,null,'associations') as tree_org_child,
							a.town_id,
							o.priority,
	             			o.super_priority,
							o.ident_code,
							o.ident_code_new,
							decode(o.ident_code_new,null,o.ident_code,o.ident_code_new) as unique_ident_code,
							o.chief,
							o.remark,
							o.work_hours,
							o.found_date,
							o.email_address,
							o.additional_info,
							o.web_address,
							o.contact_person,
							o.day_offs,
							getdaysdescription(o.day_offs) as day_offs_descr,
							o.staff_count,
							o.organization_index,
							o.organization_name_eng,						
							o.legal_form_desc_id,
							getdescription(o.legal_form_desc_id) as legal_form_desc,
							o.status,
							a.street_id,
							a.town_name,
							a.town_district_name as town_district,
							a.town_district_name as town_district_name,
							a.street_location,
							a.street_index_text,
							a.street_index_text as index_text,
							getsreetoldnames(a.street_id) as street_old_name,
							o.important_remark,						
	             			a.town_district_id,
	             		    getTbilisiOrder(a.town_id) as cust_order,
			                a.street_name,
			                a.hidden_by_request,
			                decode(a.hidden_by_request, 1, 'მისამართი დაფარულია', a.concat_address_with_town) as call_center_address,		                		                
			                a.full_address,
							a.block,
							a.appt,
							a.descr,
							a.anumber,
							o.super_priority,						
							getorgbusiness_alerts(o.organization_id) as org_allert_by_buss_det,
							o.legal_address_id,
							o.physical_address_id,
							o.social_address,
							a1.town_id as legal_addr_town_id,
							a1.street_id as legal_addr_street_id,
							a1.town_district_id as legal_addr_town_district_id,
							a1.hidden_by_request as legal_addr_hidden_by_request,
							o.old_legal_address as legal_addr_full_address,
							a1.block as legal_addr_block,
							a1.appt as legal_addr_appt,
							a1.anumber as legal_addr_anumber,
							a1.street_location as legal_addr_street_location,
							a1.street_index_text as legal_addr_street_index_text,
							a1.descr
					#end						
				 ]]>
			</selectClause>
			<tableClause>
				organizations o,
				#if($criteria.pp_organization_id)
						(
							select 
									t.organization_id, 
									level mylevel, 
									rownum as my_rownum
			  				from organizations t
			 				start with t.organization_id = 
			 				  #if($criteria.only_parrent)
			 				  	  	$criteria.pp_organization_id
			 				  #else 
			 					(
				 					  select 
				 					  			tt.organization_id
									  from (select 
									  				t.organization_id, 
									  				t.parrent_organization_id
									  		from organizations t
									        start with t.organization_id = $criteria.pp_organization_id
									        connect by prior t.parrent_organization_id = t.organization_id
									       ) tt
									  where tt.parrent_organization_id is null
								)
							  #end
							connect by prior t.organization_id = t.parrent_organization_id
							order siblings by getTbilisiOrder(t.ph_town_id), t.super_priority, nvl(t.parrent_organization_id,0), t.priority
						) hr, #end
				v_full_address a, v_full_address a1
			</tableClause>
			<whereClause>
				 <![CDATA[
						 o.physical_address_id = a.addr_id(+) and 
						 o.legal_address_id = a1.addr_id(+) 
						 
							#if($criteria.organization_name) 
								#foreach($str in $criteria.organization_name.split(" "))
									and o.organization_name like '%'||'$str'||'%'
								#end
							#end
						 	#if($criteria.organization_name_param) 
								#foreach($str in $criteria.organization_name_param.split(" "))
									and o.organization_name like '%'||'$str'||'%'
								#end
							#end
						 	
						 #if($criteria.phone)
						 	and o.organization_id in (
						 		select 
						 			distinct od.organization_id
						  		from organization_department od
						 		where od.org_department_id in
						       		  (select 
						       		  		  distinct dp.org_department_id
						          	   from organization_depart_to_phones dp
						         	   where dp.phone_number_id in
						               		(select 
						               				t.phone_number_id
						                  	 from phone_numbers t
						                 	 where t.phone = $criteria.phone
						                 	)
						              ) 
						       )
						 #end
						 
						 #if($criteria.department)
						 	and o.organization_id in (
						 		select od.organization_id from organization_department od
						 		where 1 = 1
						 		#foreach($str in $criteria.department.split(" "))
									and od.department like '%'||'$str'||'%'
								#end
						 	)						 	
						 #end
						 
						  #if($criteria.department_param)
						 	and o.organization_id in (
						 		select od.organization_id from organization_department od
						 		where 1 = 1
						 		#foreach($str in $criteria.department_param.split(" "))
									and od.department like '%'||'$str'||'%'
								#end
						 	)						 	
						 #end						 
						 
						 #if($criteria.pp_organization_id)
						 	and hr.organization_id=o.organization_id
						 #else
							 #if($criteria.parrent_organization_id) and o.parrent_organization_id = $criteria.parrent_organization_id #end
							 #if($criteria.organization_id) and o.organization_id = $criteria.organization_id #end
							 #if($criteria.pp_organization_id) and o.organization_id = $criteria.pp_organization_id #end
							 #if($criteria.remark) 
							 	 #foreach($str in $criteria.remark.split(" "))
									and o.remark like '%'||'$str'||'%'
								#end
							 #end		
							  #if($criteria.remark_param) 
							 	 #foreach($str in $criteria.remark_param.split(" "))
									and o.remark like '%'||'$str'||'%'
								#end
							 #end
							 #if($criteria.chief) 
							 	#foreach($str in $criteria.chief.split(" "))
									and o.chief like '%'||'$str'||'%'
								#end							 	
							 #end	
							 #if($criteria.chief_param) 
							 	#foreach($str in $criteria.chief_param.split(" "))
									and o.chief like '%'||'$str'||'%'
								#end
							 #end
							 #if($criteria.real_address_descr) 
							 	#foreach($str in $criteria.real_address_descr.split(" "))
							 		and a.concat_address like '%'||'$str'||'%' AND a.town_district_name not like '%'||'$str'||'%'
								#end							 	
							 #end
							 #if($criteria.town_district_id) 
							 	and ( 1<>1
									 	#foreach($str in $criteria.town_district_id.split(","))
									 		or a.town_district_id =to_number($str)
										#end
							 	) 
							 #end
							 #if($criteria.town_id) and a.town_id = $criteria.town_id #end
							 #if($criteria.ident_code) and (o.ident_code = $criteria.ident_code or o.ident_code_new = $criteria.ident_code) #end
							 #if($criteria.organization_index) and o.organization_index = $criteria.organization_index #end						 
								
							 #if($criteria.legal_real_address_descr) 
							 	#foreach($str in $criteria.legal_real_address_descr.split(" "))
							 		and a1.concat_address like '%'||'$str'||'%' AND a1.town_district_name not like '%'||'$str'||'%'
								#end							 	
							 #end
							 #if($criteria.legal_town_district_id) 
							 	and ( 1<>1
									 	#foreach($str in $criteria.legal_town_district_id.split(","))
									 		or a1.legal_town_district_id =to_number($str)
										#end
							 	) 
							 #end
							 #if($criteria.legal_town_id) and a1.legal_town_id = $criteria.legal_town_id #end
							 #if($criteria.work_hours) and o.work_hours like '%'||($criteria.work_hours)||'%' #end
							  #if($criteria.day_offs) 
							 	 #foreach($str in $criteria.day_offs.split(" "))
									and getOrgDayoffs(o.day_offs) like '%'||'$str'||'%'
								#end
							 #end
							 
							 #if($criteria.phone_upd_date) 
							 	 and o.organization_id in (
							 		select 
							 			distinct od.organization_id
							  		from organization_department od
							 		where od.org_department_id in
							       		  (select 
							       		  		  distinct dp.org_department_id
							          	   from organization_depart_to_phones dp
							          	   where dp.rec_upd_date is null or to_number(to_char(dp.rec_upd_date,'yymm')) = $criteria.phone_upd_date 							         	   
							              ) 
							       ) 
							 #end
							 #if($criteria.main_organization) and o.parrent_organization_id is null #end
							 #if($criteria.web_address) and o.web_address like '%'||($criteria.web_address)||'%' #end
							 #if($criteria.email_address) and o.email_address like '%'||($criteria.email_address)||'%' #end
							 #if($criteria.social_address) and o.social_address like '%'||($criteria.social_address)||'%' #end
							 #if($criteria.org_found_date_start) and trunc(o.found_date)>= trunc($criteria.org_found_date_start) and  trunc(o.found_date)<= trunc($criteria.org_found_date_end) #end
							 
							 #if($criteria.org_partner_banks) 
							 	and o.organization_id in (
							 		select 
							 				pb.organization_id from organization_partner_banks pb 
							 		where 1<>1 
									 	#foreach($str in $criteria.org_partner_banks.split(","))
									 		or pb.part_bank_org_id = to_number($str)  
										#end
							 	) 
							 #end
							 #if($criteria.orgActivitiesCrit)
							 	and o.organization_id in (
							 		select 
							 				oa.organization_id from organization_to_activities oa 
							 		where 1<>1 
									 	#foreach($str in $criteria.orgActivitiesCrit.split(","))
									 		or oa.org_activity_id = to_number($str)  
										#end
							 	) 
							 #end
							 #if($criteria.week_daysItemCrit)	
							 		and ( 1<>1
							 		#foreach($str in $criteria.week_daysItemCrit.split(","))
									 	or bitand($str, o.day_offs) = $str
									#end
							 	)
							 #end
							 
							 #if($criteria.org_statuses) 
							 	and ( 1<>1
									 	#foreach($str in $criteria.org_statuses.split(","))
									 		or o.status =to_number($str)
										#end
							 	) 
							 #end
							  #if($criteria.contact_person) 
							 	#foreach($str in $criteria.contact_person.split(" "))
									and o.contact_person like '%'||'$str'||'%'
								#end							 	
							 #end
						  #end
				 ]]>
			</whereClause>
			<orderClause>
						#if($criteria.pp_organization_id)
							hr.my_rownum 
						#else
							getTbilisiOrder(a.town_id), o.super_priority, nvl(o.parrent_organization_id,0), o.priority 
						#end
				
			</orderClause>
		</operationBinding>
		
		<!-- Main Service Update On Drag And Drop -->
		<operationBinding operationId="findSupperMainOrgId" operationType="fetch">
            <customSQL>
            	 <![CDATA[
            	 	select tt.organization_id
					  from (select t.organization_id, t.parrent_organization_id
					          from organizations t
					         start with t.organization_id = $criteria.organization_id
					        connect by prior t.parrent_organization_id = t.organization_id) tt
					 where tt.parrent_organization_id is null
            	 ]]>
            </customSQL> 
        </operationBinding>
        
    	<operationBinding operationId="searchMainOrgsForCBDoubleLike" operationType="fetch">
    		<selectClause>   			
    			o.organization_id,
    			o.organization_name,
    			o.remark,
    			(tw.town_name||' / '|| getDistrict(str.street_id)||' / '||str.street_name||' '||a.full_address) as full_address_not_hidden
			</selectClause> 
			<tableClause>organizations o, addresses a, streets str, towns tw</tableClause>	
			<whereClause>
					o.physical_address_id = a.addr_id and str.street_id = a.street_id and tw.town_id = a.town_id
				    #if($criteria.organization_id) and o.organization_id = $criteria.organization_id #end
					#if($criteria.organization_name) and o.organization_name like '%'||$criteria.organization_name||'%' #end				    
					#if($criteria.remark) and o.remark like '%'||$criteria.remark||'%' #end
					#if($criteria.full_address_not_hidden) and (tw.town_name||' / '|| getDistrict(str.street_id)||' / '||str.street_name||' '||a.full_address) like '%'||$criteria.full_address_not_hidden||'%' #end					
			</whereClause>				
    	</operationBinding>
    	
    	
    	<operationBinding operationId="searchOrgPartnerBanks" operationType="fetch">
    		<selectClause>   			
    			o.organization_id,
    			o.organization_name,
    			o.remark,
    			(tw.town_name||' / '|| getDistrict(str.street_id)||' / '||str.street_name||' '||a.full_address) as full_address_not_hidden
			</selectClause> 
			<tableClause>organization_partner_banks t,organizations o, addresses a, streets str, towns tw</tableClause>	
			<whereClause>
					t.part_bank_org_id = o.organization_id and o.physical_address_id = a.addr_id and str.street_id = a.street_id and tw.town_id = a.town_id
				    #if($criteria.organization_id) and t.organization_id = $criteria.organization_id #end
					#if($criteria.organization_name) and o.organization_name like '%'||$criteria.organization_name||'%' #end				    
					#if($criteria.remark) and o.remark like '%'||$criteria.remark||'%' #end
					#if($criteria.full_address_not_hidden) and (tw.town_name||' / '|| getDistrict(str.street_id)||' / '||str.street_name||' '||a.full_address) like '%'||$criteria.full_address_not_hidden||'%' #end					
			</whereClause>				
    	</operationBinding>
    	
    	
    	
    	<operationBinding operationId="searchPartnerBanks" operationType="fetch">
    		<selectClause>   			
    			o.organization_id,
    			o.organization_name,
    			o.remark,
    			(tw.town_name||' / '|| getDistrict(str.street_id)||' / '||str.street_name||' '||a.full_address) as full_address_not_hidden
			</selectClause> 
			<tableClause>organizations o, organization_to_activities oa, organization_activities aa, addresses a, streets str, towns tw</tableClause>	
			<whereClause>
					o.organization_id = oa.organization_id and oa.org_activity_id = aa.org_activity_id and aa.is_bank_activity = 1 and 
					o.physical_address_id = a.addr_id and str.street_id = a.street_id and tw.town_id = a.town_id
				    #if($criteria.organization_id) and o.organization_id = $criteria.organization_id #end
					#if($criteria.organization_name) and o.organization_name like '%'||$criteria.organization_name||'%' #end				    
					#if($criteria.remark) and o.remark like '%'||$criteria.remark||'%' #end
					#if($criteria.full_address_not_hidden) and (tw.town_name||' / '|| getDistrict(str.street_id)||' / '||str.street_name||' '||a.full_address) like '%'||$criteria.full_address_not_hidden||'%' #end					
			</whereClause>				
			<orderClause>gettbilisiorder(tw.town_id),o.organization_name</orderClause>	
    	</operationBinding>
    	
    	
    	<operationBinding operationId="searchOrgPartnerBanksHist" operationType="fetch">
    		<selectClause>   			
				part_bank_org_id organization_id,
				partnior_bank_name organization_name,
				hist_start_date,
				hist_end_date,
				start_rcn,
				end_rcn,
				on_user,
				off_user,
				rdeleted
			</selectClause> 
			<tableClause>hist_org_partner_banks o</tableClause>	
			<whereClause>
				    #if($criteria.organization_id) o.organization_id = $criteria.organization_id #end
			</whereClause>				
			<orderClause>part_bank_org_id, start_rcn desc</orderClause>	
    	</operationBinding>
    	
    	
    	<operationBinding operationId="searchOrgAcctivitiesHist" operationType="fetch">
    		<selectClause>   			
				organization_id, 
				org_activity_id, 
				org_acctivity_name, 
				hist_start_date, 
				hist_end_date, 
				start_rcn, 
				end_rcn, 
				on_user, 
				off_user, 
				rdeleted
			</selectClause> 
			<tableClause>hist_organization_to_act o</tableClause>	
			<whereClause>
				    #if($criteria.organization_id) o.organization_id = $criteria.organization_id #end
			</whereClause>				
			<orderClause>org_activity_id, start_rcn desc</orderClause>	
    	</operationBinding>
    	
    	
    	<operationBinding operationId="histSearch"
			operationType="fetch">			
			<selectClause>
				   organization_id,
			       parrent_organization_id,
			       parrent_organization,
			       original_org_name,
			       full_address_not_hidden,
			       tree_org_parrent,
			       town_id,
			       priority,
			       decode(priority, 0, 'ჩვეულებრივი', -1, 'გაწითლებული', '') as priority_descr,
			       super_priority,
			       decode(super_priority, 0, 'არაპრიორიტეტული', 'პრიორიტეტული') as super_priority_descr,
			       ident_code,
			       ident_code_new,
			       chief,
			       remark,
			       work_hours,
			       found_date,
			       email_address,
			       additional_info,
			       web_address,
			       contact_person,
			       day_offs,
			       day_offs_descr,
			       staff_count,
			       organization_index,
			       organization_name_eng,
			       legal_form_desc_id,
			       legal_form_desc,
			       status,
			       street_id,
			       town_name,
			       town_district,
			       street_location,
			       street_index_text,
			       important_remark,
			       town_district_id,
			       cust_order,
			       hidden_by_request,
			       block,
			       appt,
			       descr,
			       anumber,
			       org_allert_by_buss_det,
			       legal_address_id,
			       physical_address_id,
			       social_address,
			       legal_addr_town_id,
			       legal_addr_street_id,
			       legal_addr_town_district_id,
			       legal_addr_hidden_by_request,
			       legal_addr_full_address,
			       legal_addr_block,
			       legal_addr_appt,
			       legal_addr_anumber,
			       legal_addr_street_location,
			       legal_addr_street_index_text,
			       legal_addr_not_hidden,
			       hist_start_date,
			       hist_end_date,
			       start_rcn,
			       end_rcn,
			       on_user,
			       off_user,
			       rdeleted
			</selectClause>
			<tableClause>
			  	   hist_V_ORGANIZATION t
       		</tableClause>
			<whereClause><![CDATA[ 
				   	1 = 1
				   	#if($criteria.organization_id) AND t.organization_id = $criteria.organization_id #end
				   	#if($criteria.original_org_name) AND t.original_org_name like '%'||($criteria.original_org_name)||'%' #end
				   	#if($criteria.concat_address)  and t.concat_address like '%'||($criteria.concat_address)||'%' AND t.town_district not like '%'||($criteria.concat_address)||'%' #end
				   	#if($criteria.town_name) AND t.town_name like '%'||($criteria.town_name)||'%' #end
				   	#if($criteria.town_district) AND t.town_district like '%'||($criteria.town_district)||'%' #end
				   	#if($criteria.ident_code) AND $criteria.ident_code in (ident_code,ident_code_new) #end
				   	#if($criteria.remark) AND t.remark like '%'||($criteria.remark)||'%' #end
				   	
				   	#if($criteria.phone_number)
				   	and exists (select 1
				          from  hist_phone_numbers        hph
				          	    ,HIST_ORG_DEPART_TO_PHONES htp
				          		,HIST_ORGANIZATION_DEPARTMENT hd
				         where hph.phone = ($criteria.phone_number) 
				         	and htp.phone_number_id = hph.phone_number_id
				         	and htp.ORG_DEPARTMENT_ID = hd.ORG_DEPARTMENT_ID
				         	and hd.organization_id = t.organization_id)
				   	 #end
				   	 
				   	 	#if($criteria.departmentName)
				   	and exists (select 1
				          from  HIST_ORGANIZATION_DEPARTMENT hd
				         where hd.department like '%' || ($criteria.departmentName) || '%' 
				         	and hd.organization_id = t.organization_id )
				   	 #end
				   	]]>
			</whereClause>	
			<orderClause>t.organization_id, start_rcn desc</orderClause>
		</operationBinding>
    	
	</operationBindings>
</DataSource>