<DataSource
	ID="AbPhonesDS"
	serverType="sql"
	tableName="phone_numbers"
	qualifyColumnNames="false">
	<fields>
		<field name="phone_number_id"			type="integer"		title="ID"					hidden="true" primaryKey="true" />
		<field name="phone"						type="text" 		title="Phone"/>		
		<field name="subscriber_id"				type="integer"		title="Abonent ID" 			hidden="true"/>
		<field name="hidden_by_request"			type="integer"		title="Is Hide" 			hidden="true"/>
		<field name="hidden_by_request_descr"	type="text"			title="Is Hide Descr"/>
		<field name="is_parallel"				type="integer"		title="Is Hide" 			hidden="true"/>
		<field name="is_parallel_descr"			type="text"			title="Is Parallel Descr"/>
		<field name="phone_state_id"			type="integer"		title="Phone State ID"		hidden="true"/>		
		<field name="phone_state"				type="text"			title="Phone State"/>
		<field name="phone_contract_type"		type="integer"		title="Phone Status ID"		hidden="true"/>
		<field name="phone_contract_type_desr"	type="text"			title="Phone Status"/>
		<field name="phone_type_id"				type="integer"		title="Phone Type ID"		hidden="true"/>
		<field name="phone_type"				type="text"			title="Phone Type"/>
		<field name="hist_start_date"   		type="datetime" 	title="hs_hist_start_date"/>
		<field name="hist_end_date"   			type="datetime" 	title="hs_hist_end_date"/>
		<field name="on_user"  					type="text"  		title="hs_on_user"/>
		<field name="off_user"		   			type="text"  		title="hs_off_user"/>
		<field name="rdeleted"   				type="boolean"  	title="hph_rcn" 			sqlStorageStrategy="integer"/>
		
	</fields>	
	<serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.CommonDMI"/>
	 
	<operationBindings>
		<operationBinding operationId="getPhonesByAbonentId" operationType="fetch">    		
    		<selectClause>  
			       t.phone_number_id,
			       t.phone,
			       t.phone_state_id,
			       t.phone_type_id,
			       sp.hidden_by_request,
			       decode(sp.hidden_by_request, 0, 'ღია', 1, 'დაფარულია') hidden_by_request_descr,
			       t.is_parallel,
			       decode(t.is_parallel,
			              0,
			              'ჩვეულებრივი',
			              1,
			              'პარალელური') as is_parallel_descr,
			       t.phone_state_id,
			       ps.description phone_state,
			       sp.phone_contract_type,
			       pst.description phone_contract_type_desr,
			       t.phone_type_id,
			       pt.description phone_type
			</selectClause> 
			<tableClause>
				   PHONE_NUMBERS        t,
			       subscriber_to_phones sp,
			       descriptions         ps,
			       descriptions         pst,
			       descriptions         pt
       </tableClause>
			<whereClause><![CDATA[ 
				   t.phone_number_id = sp.phone_number_id
				   and (t.phone_state_id = ps.description_id and
				       ps.description_type_id = 52000)
				   and (t.phone_type_id = pt.description_id and
				       pt.description_type_id = 54000)
				   and (sp.phone_contract_type = pst.description_id and
				       pst.description_type_id = 53000)
				   and sp.subscriber_id = $criteria.subscriber_id
				]]>  
			</whereClause> 
			<orderClause>t.phone</orderClause>
    	</operationBinding>    
    	
    	<operationBinding operationId="getPhone" operationType="fetch" customFields="firstname, lastname, phone">    		
    		<selectClause>  
    			f.firstname as firstname,
    			l.lastname as lastname,
    			t.phone
			</selectClause> 
			<tableClause>phone_numbers t,subscriber_to_phones sp,subscribers a, names f, familynames l</tableClause>
			<whereClause><![CDATA[ 
				 t.phone_number_id = sp.phone_number_id
			     and sp.subscriber_id = a.subscriber_id
			     and f.name_id = a.name_id
			     and l.familyname_id = a.family_name_id
				 and t.phone = $criteria.phone
				 #if($criteria.subscriber_id) AND a.subscriber_id != $criteria.subscriber_id  #end 
				]]>  
			</whereClause> 
			<orderClause>t.phone</orderClause>
    	</operationBinding>   
    	
    	
    	<operationBinding operationId="getPhoneHistoryForSubscriber" operationType="fetch" >    		
    		<selectClause>  
				subscriber_id, 
				hidden_by_request_descr, 
				phone_contract_type, 
				phone_contract_type_desr, 
				phone_number_id, 
				phone, 
				phone_state_id, 
				phone_state, 
				phone_type_id, 
				phone_type, 
				is_parallel,
				is_parallel_descr, 
				hist_start_date,
				hist_end_date,
				on_user,
				off_user,
				rdeleted
			</selectClause> 
			<tableClause>v_hist_subscriber_numbers t</tableClause>
			<whereClause><![CDATA[ 
				#if($criteria.subscriber_id )
				 t.subscriber_id = $criteria.subscriber_id
				#else
					1=0
				#end	 
				]]>  
			</whereClause> 
			<orderClause> phone, start_rcn desc</orderClause>
    	</operationBinding>     		
    </operationBindings>	
</DataSource>