<DataSource 
	ID="OrgDepartmentDS" 
	serverType="sql"
	tableName="organization_department" 
	qualifyColumnNames="false"
	dropExtraFields = "false">
	<fields>
		<field name="org_department_id" 				type="integer" 		title="org_department_id" 					hidden="true" 	primaryKey="true" />
		<field name="parrent_department_id"				type="integer" 		title="parrent_department_id"				hidden="true" 	foreignKey="OrgDepartmentDS.org_department_id"  detail="true"/>
		<field name="parrent_department_id1"			type="integer" 		title="parrent_department_id1"				hidden="true"/>
		<field name="organization_id" 					type="integer" 		title="organization_id" 					hidden="true" />
		<field name="inner_order" 						type="integer" 		title="inner_order" 						hidden="true" />
		<field name="legal_address_id" 					type="integer" 		title="legal_address_id" 					hidden="true" />
		<field name="physical_address_id" 				type="integer" 		title="physical_address_id" 				hidden="true" />
		<field name="department" 						type="text" 		title="department" />		
		<field name="department_original" 				type="text" 		title="department_original" />
		<field name="remark" 							type="text" 		title="remark" />
		<field name="tree_parrent"						type="text"  		title="tree_org_parrent"					hidden="true"/>
		<field name="tree_child"						type="text"  		title="tree_org_child"						hidden="true"/>
		<field name="street_id" 						type="integer" 		title="street_id" 							hidden="true" />
		<field name="real_address_descr"				type="text"  		title="real_address_descr"					hidden="true"/>
		<field name="town_name"							type="text"  		title="town_name"							hidden="true"/>
		<field name="town_district"						type="text"  		title="town_district"						hidden="true"/>
		<field name="street_location"					type="text"  		title="street_location"						hidden="true"/>
		<field name="street_index_text"					type="text"  		title="street_index_text"					hidden="true"/>
		<field name="town_id" 							type="integer" 		title="town_id" 							hidden="true" />
		<field name="town_district_id" 					type="integer" 		title="town_district_id" 					hidden="true" />
		<field name="legal_addr_town_id" 				type="integer" 		title="legal_addr_town_id" 					hidden="true" />
		<field name="legal_addr_street_id" 				type="integer" 		title="legal_addr_street_id" 				hidden="true" />
		<field name="legal_addr_town_district_id" 		type="integer" 		title="legal_addr_town_district_id" 		hidden="true" />
		<field name="legal_addr_hidden_by_request"		type="integer" 		title="legal_addr_hidden_by_request" 		hidden="true" />
		<field name="hidden_by_request" 				type="integer" 		title="hidden_by_request"					hidden="true" />
		<field name="phone_count" 						type="integer" 		title="phone_count"							hidden="true" />
		<field name="full_address"						type="text"  		title="full_address"						hidden="true"/>
		<field name="street_name"						type="text"  		title="street_name"							hidden="true"/>
		<field name="block"								type="text"  		title="block"								hidden="true"/>
		<field name="appt"								type="text"  		title="appt"								hidden="true"/>
		<field name="descr"								type="text"  		title="descr"								hidden="true"/>
		<field name="anumber"							type="text"  		title="anumber"								hidden="true"/>
		<field name="full_address_not_hidden"			type="text"  		title="full_address_not_hidden"				hidden="true"/>
		<field name="legal_addr_full_address"			type="text"  		title="legal_addr_full_address"				hidden="true"/>
		<field name="legal_addr_block"					type="text"  		title="legal_addr_block"					hidden="true"/>
		<field name="legal_addr_appt"					type="text"  		title="legal_addr_appt"						hidden="true"/>
		<field name="legal_addr_anumber"				type="text"  		title="legal_addr_anumber"					hidden="true"/>
		<field name="legal_addr_street_location"		type="text"  		title="legal_addr_street_location"			hidden="true"/>
		<field name="legal_addr_street_index_text"		type="text"  		title="legal_addr_street_index_text"		hidden="true"/>
		<field name="isBold" 							type="integer" 		title="isBold" 								hidden="true" />
		<field name="phones" 							type="any" 			title="phones" 								hidden="true" />
		<field name="physicalAddrValues" 				type="any" 			title="physicalAddrValues" 					hidden="true" />
		<field name="orgDepIdList" 						type="any" 			title="orgDepIdList" 						hidden="true" />
		<field name="recCount" 							type="integer" 		title="recCount" 							hidden="true" />
		<field name="organization_name"  				type="text"  		title="organization_name"/>
		<field name="parrent_org_department"  			type="text"  		title="parrent_org_department"/>
		<field name="hist_start_date"   				type="datetime" 	title="hs_hist_start_date"/>
		<field name="hist_end_date"   					type="datetime" 	title="hs_hist_end_date"/>
		<field name="on_user"  							type="text"  		title="hs_on_user"/>
		<field name="off_user"		   					type="text"  		title="hs_off_user"/>
		<field name="rdeleted"   						type="boolean"  	title="hph_rcn" 							sqlStorageStrategy="integer"/>
				
	</fields>

	<operationBindings>
		
		<!-- Add New Organization -->
		<operationBinding operationType="add" operationId="addOrganizationDepartment" serverMethod="addOrUpdateOrganizationDepartment">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.OrganizationDMI"/>
        </operationBinding>
        <operationBinding operationType="update" operationId="updateOrganizationDepartment" serverMethod="addOrUpdateOrganizationDepartment">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.OrganizationDMI"/>
        </operationBinding>
		<operationBinding operationType="remove" operationId="removeOrganizationDepartment" serverMethod="removeOrganizationDepartment">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.OrganizationDMI"/>
        </operationBinding>
        <operationBinding operationType="update" operationId="updateOrgDepSortOrder" serverMethod="updateOrgDepSortOrder">
            <serverObject lookupStyle="new" className="com.info08.billing.callcenterbk.server.impl.dmi.OrganizationDMI"/>
        </operationBinding>
	
		<!-- FETCH -->
		<operationBinding operationId="customOrgDepSearchByOrgId" operationType="fetch">			
			<selectClause>
					  t1.department, 
					  t1.department as department_original,
					  t1.legal_address_id,
					  t1.physical_address_id,
					  t1.parrent_department_id,
					  t1.org_department_id,
					  t1.organization_id,
					  t1.remark,
					  pa.street_id,
					  decode(pa.hidden_by_request,1,'მისამართი დაფარულია',pa.town_name || ', ' ||pa.town_district_name||', '||pa.street_name||' '||pa.full_address) as real_address_descr,
					  pa.town_name,
					  pa.town_district_name as town_district,
					  pa.street_location,
					  getStreetIndex(pa.street_id) as street_index_text,
					  pa.town_id,
					  pa.town_district_id,
					  decode(pa.hidden_by_request,1,'მისამართი დაფარულია',(pa.town_name||' / '|| pa.town_district_name||' / '||pa.street_name||' '||pa.full_address)) as full_address,
					  pa.street_name,
					  pa.hidden_by_request,
					  decode(t1.parrent_department_id,null,null,'home') as tree_parrent,
					  decode((select min(1) from organization_department ms1 where ms1.parrent_department_id = t1.org_department_id),null,null,'associations') as tree_child,
					  pa.full_address as old_address,
					  pa.block,
					  pa.appt,
					  pa.descr,
					  pa.anumber,
					  pa.concat_address as full_address_not_hidden,
					  la.town_id as legal_addr_town_id,
					  la.street_id as legal_addr_street_id,
					  la.town_district_id as legal_addr_town_district_id,
					  la.hidden_by_request as legal_addr_hidden_by_request,
					  la.full_address as legal_addr_full_address,
					  la.block as legal_addr_block,
					  la.appt as legal_addr_appt,
					  la.anumber as legal_addr_anumber,
					  la.street_location as legal_addr_street_location,
					  getStreetIndex(la.street_id) as legal_addr_street_index_text
			</selectClause>
			<tableClause>organization_department t1, V_FULL_ADDRESS pa, V_FULL_ADDRESS la</tableClause>
			<whereClause>
				 <![CDATA[
				 	t1.physical_address_id = pa.addr_id(+) and
				 	t1.legal_address_id = la.addr_id(+) 
				 	#if($criteria.organization_id) and t1.organization_id = $criteria.organization_id #end
				 	#if($criteria.department) and t1.department like '%'||$criteria.department||'%' #end
				 	#if($criteria.org_department_id) and t1.org_department_id = $criteria.org_department_id #end
				 	#if($criteria.parrent_department_id) and nvl(t1.parrent_department_id,-100000) = $criteria.parrent_department_id #end
				 ]]>
			</whereClause>
			<orderClause>nvl(t1.parrent_department_id,0), t1.inner_order</orderClause>
		</operationBinding>
	
        <!-- FETCH -->
        <operationBinding operationId="orgDepartSearch" operationType="fetch">
            <customSQL>
            	 <![CDATA[
            		select 
            		  t1.isBold,
					  t1.department, 
					  t1.department_original,
					  t1.legal_address_id,
					  t1.physical_address_id,
					  t1.parrent_department_id,
					  t1.org_department_id,
					  t1.organization_id,
					  t1.remark,
					  t1.inner_order,
					  pa.street_id,
					  pa.concat_address_with_town as real_address_descr,
					  pa.town_name,
					  pa.town_district_name as town_district,
					  pa.street_location,
					  getStreetIndex(pa.street_id) as street_index_text,
					  pa.town_id,
					  pa.town_district_id,
					  decode(pa.hidden_by_request,1,'მისამართი დაფარულია',(pa.town_name||' / '|| pa.town_district_name||' / '||pa.street_name||' '||pa.full_address)) as full_address,
					  pa.street_name,
					  pa.hidden_by_request,
					  decode(t1.parrent_department_id,null,null,'home') as tree_parrent,
					  decode((select min(1) from organization_department ms1 where ms1.parrent_department_id = t1.org_department_id),null,null,'associations') as tree_child,
					  pa.full_address as old_address,
					  pa.block,
					  pa.appt,
					  pa.descr,
					  pa.anumber,
					  #if($criteria.with_phone_count) (select count(1) from organization_depart_to_phones odp where odp.org_department_id=t1.org_department_id) phone_count, #end
					  pa.concat_address_with_town as full_address_not_hidden,
					  la.town_id as legal_addr_town_id,
					  la.street_id as legal_addr_street_id,
					  la.town_district_id as legal_addr_town_district_id,
					  la.hidden_by_request as legal_addr_hidden_by_request,
					  la.full_address as legal_addr_full_address,
					  la.block as legal_addr_block,
					  la.appt as legal_addr_appt,
					  la.anumber as legal_addr_anumber,
					  la.street_location as legal_addr_street_location,
					  getStreetIndex(la.street_id) as legal_addr_street_index_text
					  
					from (
					select 
					     decode(LEVEL,1,1,0) isBold,
					     LPAD(' ', (LEVEL - 1) * 4, '.') || dd.department department,
					     dd.department as department_original,
					     dd.remark,
					     dd.legal_address_id,
					     dd.physical_address_id,
					     dd.parrent_department_id,
					     dd.org_department_id,
					     dd.organization_id,
					     dd.inner_order
					from (SELECT o.org_department_id, o.parrent_department_id
					        FROM organization_department o
					       start with o.org_department_id in
					                  (select kk.org_department_id
					                     from organization_department kk
					                     	
					                     	#if($criteria.department_real_address)
					                     		left join V_FULL_ADDRESS da on da.addr_id = kk.physical_address_id
					                     	#end
					                     		
					                    where 1=1
					                    	#if($criteria.organization_id) and kk.organization_id = $criteria.organization_id #end
					                    	#if($criteria.org_department_id) and kk.org_department_id = $criteria.org_department_id #end
					                    	#if($criteria.department1) and kk.department like '%'||($criteria.department1)||'%' #end
					                        #if($criteria.department2) and kk.department like '%'||($criteria.department2)||'%' #end
					                        #if($criteria.department3) and kk.department like '%'||($criteria.department3)||'%' #end
					                        #if($criteria.department4) and kk.department like '%'||($criteria.department4)||'%' #end
					                        #if($criteria.department5) and kk.department like '%'||($criteria.department5)||'%' #end
					                        #if($criteria.department6) and kk.department like '%'||($criteria.department6)||'%' #end
					                        #if($criteria.department7) and kk.department like '%'||($criteria.department7)||'%' #end
					                        #if($criteria.department8) and kk.department like '%'||($criteria.department8)||'%' #end
					                        #if($criteria.department9) and kk.department like '%'||($criteria.department9)||'%' #end
					                        #if($criteria.phone || $criteria.for_contact)
					                        	and exists (
					                        		select 
					                        			1 
					                        		from organization_depart_to_phones p
                     									inner join phone_numbers pn on pn.phone_number_id = p.phone_number_id
              										where 
              											kk.org_department_id = p.org_department_id 
              											#if($criteria.phone)
              											    and pn.phone = $criteria.phone
              											#end              											
              											#if($criteria.for_contact)
              												and p.for_contact = $criteria.for_contact 
              											#end
					                        	) 
					                        #end
					                        #if($criteria.department_real_address)
									 			#foreach($str in $criteria.department_real_address.split(" "))
													and da.concat_address_with_town like '%'||'$str'||'%'
												#end
					 						#end					 						
					                   )
					      connect by prior o.parrent_department_id = o.org_department_id
					      union
					      SELECT o.org_department_id, o.parrent_department_id
					        FROM organization_department o
					       start with o.org_department_id in
					                  (select kk.org_department_id
					                     from organization_department kk
					                     	
					                     	#if($criteria.department_real_address)
					                     		left join V_FULL_ADDRESS da on da.addr_id = kk.physical_address_id
					                     	#end
					                     	
					                    where 1=1
					                    	#if($criteria.organization_id) and kk.organization_id = $criteria.organization_id #end
					                    	#if($criteria.org_department_id) and kk.org_department_id = $criteria.org_department_id #end
					                        #if($criteria.department1) and kk.department like '%'||($criteria.department1)||'%' #end
					                        #if($criteria.department2) and kk.department like '%'||($criteria.department2)||'%' #end
					                        #if($criteria.department3) and kk.department like '%'||($criteria.department3)||'%' #end
					                        #if($criteria.department4) and kk.department like '%'||($criteria.department4)||'%' #end
					                        #if($criteria.department5) and kk.department like '%'||($criteria.department5)||'%' #end
					                        #if($criteria.department6) and kk.department like '%'||($criteria.department6)||'%' #end
					                        #if($criteria.department7) and kk.department like '%'||($criteria.department7)||'%' #end
					                        #if($criteria.department8) and kk.department like '%'||($criteria.department8)||'%' #end
					                        #if($criteria.department9) and kk.department like '%'||($criteria.department9)||'%' #end
					                        #if($criteria.phone || $criteria.for_contact)
					                        	and exists (
					                        		select 
					                        			1 
					                        		from organization_depart_to_phones p
                     									inner join phone_numbers pn on pn.phone_number_id = p.phone_number_id
              										where 
              											kk.org_department_id = p.org_department_id 
              											#if($criteria.phone)
              											    and pn.phone = $criteria.phone
              											#end              											
              											#if($criteria.for_contact)
              												and p.for_contact = $criteria.for_contact 
              											#end
					                        	) 
					                        #end
					                        #if($criteria.department_real_address)
									 			#foreach($str in $criteria.department_real_address.split(" "))
													and da.concat_address_with_town like '%'||'$str'||'%'
												#end
					 						#end
					                   )
					      connect by prior o.org_department_id = o.parrent_department_id) f
					inner join organization_department dd on dd.org_department_id = f.org_department_id
					start with f.parrent_department_id is null
					connect by prior f.org_department_id = f.parrent_department_id
					order siblings by dd.inner_order ) t1
					left join V_FULL_ADDRESS pa on pa.addr_id = t1.physical_address_id 
					left join V_FULL_ADDRESS la on la.addr_id = t1.legal_address_id
            	 ]]>
            </customSQL> 
        </operationBinding>
        
        <!-- FETCH -->
        <operationBinding operationId="orgDepartSearchCustom1" operationType="fetch">
            <customSQL>
            	 <![CDATA[
            	     select *
					  from (select level m_level, t.*
					          from organization_department t
					         start with t.org_department_id = $criteria.org_department_id
					        connect by prior t.org_department_id = t.parrent_department_id
					         order siblings by t.inner_order) k
					 order by k.m_level desc
            	 ]]>
            </customSQL> 
        </operationBinding>
        
        <!-- FETCH -->
        <operationBinding operationId="orgDepartSearchCustom2" operationType="fetch">
            <customSQL>
            	 <![CDATA[
            	     select t2.org_department_id
					 from (select level as my_level, t1.org_department_id
					          from (select distinct t.org_department_id, t.parrent_department_id
					                  from organization_department t
					                 start with t.organization_id = $criteria.organization_id
					                connect by prior t.org_department_id = t.parrent_department_id) t1
					         start with t1.parrent_department_id is null
					        connect by prior t1.org_department_id = t1.parrent_department_id) t2
					 order by t2.my_level desc
            	 ]]>
            </customSQL> 
        </operationBinding>
        
        
        <!-- FETCH -->
        <operationBinding operationId="orgDepartCheckParrChild" operationType="fetch">
            <customSQL>
            	 <![CDATA[
            	     select 
            	     		count(1) as recCount
					 from (select level as my_level, t.*
					          from organization_department t
					         start with t.org_department_id = $criteria.curr_org_department_id
					        connect by prior t.org_department_id = t.parrent_department_id) tt
					 where tt.my_level > 1
					   and tt.org_department_id = $criteria.parr_org_department_id
            	 ]]>
            </customSQL> 
        </operationBinding>


<operationBinding operationId="searchOrgDepartmentHist" operationType="fetch">			
			<selectClause>
					department, 
					legal_address_id, 
					physical_address_id, 
					parrent_department_id, 
					org_department_id, 
					organization_id, 
					organization_name, 
					parrent_org_department, 
					remark, 
					street_id, 
					town_name, 
					town_district, 
					street_location, 
					street_index_text, 
					town_id, 
					town_district_id, 
					hidden_by_request_desc, 
					street_name, 
					hidden_by_request, 
					tree_parrent, 
					tree_child, 
					old_address, 
					block, 
					appt, 
					descr, 
					anumber, 
					full_address_not_hidden, 
					hist_start_date, 
					hist_end_date, 
					start_rcn, 
					end_rcn, 
					on_user, 
					off_user, 
					rdeleted
			</selectClause>
			<tableClause>HIST_V_ORGANIZATION_DEPARTMENT</tableClause>
			<whereClause>
				 <![CDATA[
				 	#if($criteria.organization_id) organization_id = $criteria.organization_id #end
				 ]]>
			</whereClause>
			<orderClause>department, start_rcn desc</orderClause>
		</operationBinding>

	</operationBindings>
</DataSource>