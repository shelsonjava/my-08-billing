<DataSource
	ID="ContractorsPhonesDS"
	serverType="sql"
	tableName="ccare.contractor_phones"
	qualifyColumnNames="false"
	dropExtraFields = "false">
	<fields>
		<field name="cp_id"				type="integer"		title="cp_id"			hidden="true" 	primaryKey="true" />
		<field name="phone"				type="text"			title="phone"/>
		<field name="contract_id"		type="integer"		title="contract_id"		hidden="true"/>
		<field name="pr"				type="integer"		title="phone"			hidden="true"/>
		<field name="name"				type="text"			title="name"/>
		<field name="id"				type="text"			title="phone"			hidden="true"/>
		<field name="pid"				type="text"			title="phone"			hidden="true"/>
		<field name="rid"				type="integer"			title="phone"			hidden="true"/>
	</fields>
	<operationBindings>		
    	<operationBinding operationId="searchContractorPhones" operationType="fetch">
    		<selectClause>
    			   *
			</selectClause> 
			<tableClause>ccare.contractor_phones t</tableClause>
			<whereClause><![CDATA[
				 t.contract_id = $criteria.contract_id 
				]]>  
			</whereClause> 
			<orderClause>t.cp_id</orderClause>
    	</operationBinding>


    	<operationBinding operationId="searchPhones" operationType="fetch">
    		<selectClause>
    			   phone
			</selectClause> 
			<tableClause>(
					select pn.phone
					  from organization_depart_to_phones odp
					 inner join phone_numbers pn
					    on pn.phone_number_id = odp.phone_number_id
					 inner join (select d.org_department_id, d.organization_id
					               from organization_department d
					               #if($criteria.organization_id)
					                inner join (select o.organization_id
					                           from organizations o
					                          start with o.organization_id = 80353
					                         connect by prior o.organization_id =
					                                     o.parrent_organization_id) k
					                 on k.organization_id = d.organization_id
					                 start with parrent_department_id is null
					               #end
					              #if($criteria.org_department_id)
					               start with d.org_department_id=$criteria.org_department_id
					              #end
					             connect by prior org_department_id = parrent_department_id) c
					    on c.org_department_id = odp.org_department_id
					group by phone
			)</tableClause>
			<whereClause><![CDATA[
				 1=1 
				]]>  
			</whereClause> 
			
    	</operationBinding>

    	
    	<operationBinding operationId="organisationPhones" operationType="fetch">
    		<selectClause>
    			    name,
    			    pr,
    			    phone,
    			    cp_id,
    			    id,
    			    pid,
    			    rid
			</selectClause> 
			<tableClause>
				(select phns.name, pr, phns.phone, cp_id, organization_id, org_department_id,id,pid,rid
				  from (select LPAD(' ', (LEVEL - 1) * 4, '.') || name name,
				               t.pr,
				               decode(t.pr, 3, t.name, null) phone,
				               organization_id,
				               org_department_id,
               				   id,
               				   pid,
               				   rid
				          from (
				                
				                select *
				                  from (select o.organization_id rid,
				                                o.parrent_organization_id rpid,
				                                'a' || o.organization_id id,
				                                decode(o.parrent_organization_id,
				                                       null,
				                                       null,
				                                       'a' || o.parrent_organization_id) pid,
				                                o.organization_name name,
				                                rownum rn,
				                                1 pr,
				                                level lev,
				                                o.organization_id,
				                                null org_department_id
				                           from organizations o
				                          start with o.organization_id = $criteria.organization_id
				                         connect by prior o.organization_id =
				                                     o.parrent_organization_id
				                          order siblings by o.priority, o.super_priority, o.important_remark)
				                union all
				                select *
				                  from (select /*+ index(d,IX_ORG_DEP_ORG_ID)*/
				                         d.org_department_id cid,
				                         d.parrent_department_id rpid,
				                         'b' || d.org_department_id id,
				                         decode(d.parrent_department_id,
				                                null,
				                                'a' || d.organization_id,
				                                'b' || d.parrent_department_id) parent_id,
				                         d.department,
				                         rownum rn,
				                         2 tp,
				                         level lv,
				                         d.organization_id,
				                         d.org_department_id
				                          from organization_department d
				                         inner join ccare.organization_depart_to_phones odp
				                            on odp.org_department_id = d.org_department_id
				                         inner join (select o.organization_id
				                                      from organizations o
				                                     start with o.organization_id = $criteria.organization_id
				                                    connect by prior o.organization_id =
				                                                o.parrent_organization_id) k
				                            on k.organization_id = d.organization_id
				                         start with parrent_department_id is null
				                        connect by prior
				                                    d.org_department_id = parrent_department_id
				                        
				                        )
				                union all
				                select *
				                  from (select pn.phone_number_id,
				                               odp.org_department_id pid,
				                               'c' || pn.phone_number_id,
				                               'b' || odp.org_department_id,
				                               cast(pn.phone as nvarchar2(4000)),
				                               rownum,
				                               3,
				                               1,
				                               organization_id,
				                               odp.org_department_id
				                          from organization_depart_to_phones odp
				                         inner join phone_numbers pn
				                            on pn.phone_number_id = odp.phone_number_id
				                         inner join (select d.org_department_id,
				                                           d.organization_id
				                                      from organization_department d
				                                     inner join (select o.organization_id
				                                                  from organizations o
				                                                 start with o.organization_id =
				                                                            $criteria.organization_id
				                                                connect by prior
				                                                            o.organization_id =
				                                                            o.parrent_organization_id) k
				                                        on k.organization_id =
				                                           d.organization_id
				                                     start with parrent_department_id is null
				                                    connect by prior org_department_id =
				                                                parrent_department_id) c
				                            on c.org_department_id = odp.org_department_id
				                         order by odp.org_department_id, pn.phone)) t
				         start with pr = 1
				        connect by prior id = pid
				         order siblings by t.pr, t.lev, t.rn) phns
				  left join ccare.contractor_phones t
				    on t.contract_id = $criteria.contract_id
				   and phns.pr = 3
				   and phns.phone = t.phone
				)
			</tableClause>
			<whereClause>
			1=1
			</whereClause> 
    	</operationBinding>
    	
    </operationBindings>
    
    
</DataSource>