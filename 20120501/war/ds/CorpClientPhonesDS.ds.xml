<DataSource
	ID="CorpClientPhonesDS"
	serverType="sql"
	tableName="corp_client_phones"
	qualifyColumnNames="false"
	dropExtraFields = "false">
	<fields>
		<field name="corp_client_phone_id"	type="integer"		title="corp_client_phone_id"	hidden="true" 	primaryKey="true" />
		<field name="phone_number"			type="text"			title="phone_number"/>
		<field name="corporate_client_id"	type="integer"		title="corporate_client_id"		hidden="true"/>
		<field name="pr"					type="integer"		title="phone"					hidden="true"/>
		<field name="name"					type="text"			title="name"/>
		<field name="id"					type="text"			title="phone"					hidden="true"/>
		<field name="pid"					type="text"			title="phone"					hidden="true"/>
		<field name="rid"					type="integer"		title="phone"					hidden="true"/>
	</fields>
	<operationBindings>		
    	<operationBinding operationId="searchContractorPhones" operationType="fetch">
    		<selectClause>
    			   phone_number
			</selectClause> 
			<tableClause>corp_client_phones t</tableClause>
			<whereClause><![CDATA[
				 t.corporate_client_id = $criteria.corporate_client_id 
				]]>  
			</whereClause> 
			<orderClause>t.corp_client_phone_id</orderClause>
    	</operationBinding>


    	<operationBinding operationId="searchPhonesHirarchy" operationType="fetch">
    		<selectClause>
    			   phone_number
			</selectClause> 
			<tableClause><![CDATA[(
					select pn.phone as phone_number
					  from organization_depart_to_phones odp
					 inner join phone_numbers pn
					    on pn.phone_number_id = odp.phone_number_id
					 inner join (select d.org_department_id, d.organization_id
					               from organization_department d
					               #if($criteria.organization_id)
					                inner join (select o.organization_id
					                           from organizations o
					                          start with o.organization_id = $criteria.organization_id
					                         connect by prior o.organization_id =
					                                     o.parrent_organization_id) k
					                 on k.organization_id = d.organization_id
					                 start with parrent_department_id is null
					               #end
					              #if($criteria.org_department_id)
					               start with d.org_department_id=$criteria.org_department_id
					              #end
					             connect by prior org_department_id = parrent_department_id) c
					    on c.org_department_id = odp.org_department_id
					    where pn.phone_state_id <> 52102
					group by phone
			)]]></tableClause>
			<whereClause><![CDATA[
				 1=1 
				]]>  
			</whereClause> 
			
    	</operationBinding>


		<operationBinding operationId="searchPhones" operationType="fetch">
    		<selectClause>
    			   phone_number
			</selectClause> 
			<tableClause><![CDATA[(
					select pn.phone as phone_number
					  from organization_depart_to_phones odp
					 inner join phone_numbers pn
					    on pn.phone_number_id = odp.phone_number_id
					 inner join (select d.org_department_id, d.organization_id
					               from organization_department d
					               #if($criteria.organization_id)
					                 where d.organization_id=$criteria.organization_id
					               #end
					              #if($criteria.org_department_id)
					               start with d.org_department_id=$criteria.org_department_id
					              #end
					             connect by prior org_department_id = parrent_department_id) c
					    on c.org_department_id = odp.org_department_id
					    where pn.phone_state_id <> 52102
					group by phone
			)]]></tableClause>
			<whereClause><![CDATA[
				 1=1 
				]]>  
			</whereClause> 
			
    	</operationBinding>
    	
    	<operationBinding operationId="organisationPhones" operationType="fetch">
    		<selectClause>
    			    name,
    			    pr,
    			    phone_number,
    			    corp_client_phone_id,
    			    id,
    			    pid,
    			    rid
			</selectClause> 
			<tableClause>
				(select phns.name, pr, phns.phone_number, corp_client_phone_id, organization_id, org_department_id,id,pid,rid
				  from (select LPAD(' ', (LEVEL - 1) * 4, '.') || name name,
				  				
				               t.pr,
				               decode(t.pr, 3, t.name, null) phone,
				               organization_id,
				               org_department_id,
               				   id,
               				   pid,
               				   rid
				          from (
				                
				                select *
				                  from (select o.organization_id rid,
				                                o.parrent_organization_id rpid,
				                                'a' || o.organization_id id,
				                                decode(o.parrent_organization_id,
				                                       null,
				                                       null,
				                                       'a' || o.parrent_organization_id) pid,
				                                o.organization_name name,
				                                rownum rn,
				                                1 pr,
				                                level lev,
				                                o.organization_id,
				                                null org_department_id
				                           from organizations o
				                          start with o.organization_id = $criteria.organization_id
				                         connect by prior o.organization_id =
				                                     o.parrent_organization_id
				                          order siblings by o.priority, o.super_priority, o.important_remark)
				                union all
				                select *
				                  from (select /*+ index(d,IX_ORG_DEP_ORG_ID)*/
				                         d.org_department_id cid,
				                         d.parrent_department_id rpid,
				                         'b' || d.org_department_id id,
				                         decode(d.parrent_department_id,
				                                null,
				                                'a' || d.organization_id,
				                                'b' || d.parrent_department_id) parent_id,
				                         d.department,
				                         rownum rn,
				                         2 tp,
				                         level lv,
				                         d.organization_id,
				                         d.org_department_id
				                          from organization_department d
				                         inner join (select o.organization_id
				                                      from organizations o
				                                     start with o.organization_id = $criteria.organization_id
				                                    connect by prior o.organization_id =
				                                                o.parrent_organization_id) k
				                            on k.organization_id = d.organization_id
				                        where exists (select 1 from organization_depart_to_phones odp where odp.org_department_id=d.org_department_id)
				                         start with parrent_department_id is null
				                        connect by prior
				                                    d.org_department_id = parrent_department_id
				                        
				                        )
				               
				                         ) t
				         start with pr = 1
				        connect by prior id = pid
				         order siblings by t.pr, t.lev, t.rn) phns
				  left join corp_client_phones t
				    on t.corporate_client_id = $criteria.corporate_client_id
				   and phns.pr = 3
				   and phns.phone = t.phone_number
				)
			</tableClause>
			<whereClause>
			1=1
			</whereClause> 
    	</operationBinding>
    	
    </operationBindings>
    
    
</DataSource>